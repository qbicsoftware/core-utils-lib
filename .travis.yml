# Build script for Travis CI
#

# use xenial distribution
dist: xenial

# no need for Oracle's JDK
language: java
jdk: openjdk8

# speed up builds by caching maven local repository
# we are also using python via conda/pip
cache:
  directories:
  - "$HOME/.m2/repository"
  - "$HOME/.cache/pip"
  - "$HOME/miniconda3"

# as agreed in our SOP
branches:
  only:
  - master
  - development
  # Travis treats pushed tags as branches
  - /^[vV]?\d+\.\d+\.\d+$/ # matches e.g., v1.2.3, 1.2.3, V1.2.3

# added to make logs look cleaner, crisper, certified fresh
before_install: unset _JAVA_OPTIONS 

# speed up builds by telling Travis that we don't need any special "installation"
install: true

# check if we need to add a license file for Vaadin charts
before_script: if [ "$VAADIN_CHARTS_LICENSE_CODE" != "" ]; then
                  echo "$VAADIN_CHARTS_LICENSE_CODE" > ~/.vaadin.charts.developer.license;
               fi;

# as agreed in our SOP, build everything (don't deploy, just try to 'mvn install' locally, which covers all phases)
script: mvn --quiet --activate-profiles !development-build,!release-build --settings .travis.settings.xml clean cobertura:cobertura package
# upload code coverage report, generate maven site (javadocs, documentation, static code analysis, etc.)
after_success: 
- bash <(curl -s https://codecov.io/bash)

# upload to maven
deploy:
  # as agreed in our SOP, builds on development branch will deploy to our maven repository after validating
  # the artifact has a proper SNAPSHOT version
  # make sure to skip integration tests! (using -DskipITs)
- skip_cleanup: true
  provider: script
  script: mvn --quiet --activate-profiles development-build,!release-build --settings .travis.settings.xml deploy -DskipITs
  on:
    branch: development
    condition: '"$TRAVIS_EVENT_TYPE" = "push"'
  # as agreed in our SOP, releases are performed by tagging commits,
  # the version string and version of dependencies are validated (no snapshots allowed)
- skip_cleanup: true
  provider: script
  script: mvn --quiet --activate-profiles !development-build,release-build --settings .travis.settings.xml deploy -DskipITs
  on:
    condition: '"$TRAVIS_EVENT_TYPE" = "push"'
    tags: true

# upload maven site to gh-pages branch
# we need python 3+
after_deploy: 
  - wget --output-document Miniconda3-latest-Linux-x86_64.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && chmod +x Miniconda3-latest-Linux-x86_64.sh && ./Miniconda3-latest-Linux-x86_64.sh -b -f
  - $HOME/miniconda3/bin/conda update --yes -n base -c defaults conda
  - $HOME/miniconda3/bin/conda create --yes --channel conda-forge --name qbic-docs-build python=3
  - echo ". $HOME/miniconda3/etc/profile.d/conda.sh" >> ~/.bashrc && source ~/.bashrc && conda activate qbic-docs-build
  - ./.generate-reports.py $TRAVIS_BRANCH $TRAVIS_REPO_SLUG "[skip travis] Updated gh-pages" "This commit was performed from travis-ci.com using a personal access key" "Build ID $TRAVIS_BUILD_ID" "Job ID TRAVIS_JOB_ID" "Branch $TRAVIS_BRANCH" "Log of this build found at $TRAVIS_JOB_WEB_URL"
#
# encrypted deploying credentials
env:
  global:
    - secure: "Yd1readFWFHCdpWS/+r+UfQ1a2r/myHStVYnMhqsi4bbo/cvTdMutSyEZvkZ5WMBncUx7LM4Y0uhm/Eg3UnrWe/dwM51NzJRk+46iH5QoIsvaJXV0VBXhcrdeSTQMTdeXEHab/UXUNUPb6cZIXUq7fmBuUN+reYGpYj3w3WGBzkmQWwW7adkxr+VJyDp0nt+Qxewbp+/s3miI1FgR/SsGXoi6SGGZKqmUs/chc8grpEEVKJ8B8Gk+EJSFy1D5PLGXS3HrGKFFCWEYm2bah9z1KATWUJkbCnEAFS2beEKajDjryN/iqnxA6+i1PPqxuPr/nOzBohToBiZ0vEfAZSHpGiHqZ/bVqmYidJtbtJ1HkTOVGVyS8NpfImTSp4Ch3xqGmEbFy1m4semlwb+NQTGYDdq/PfiQl91X14omtLjvJrjlbrkqVhr4lcZf2mV5uINNwyZJkXEu3Xoivlaem56DopZr/F+bdzXCc0LkklKgr1LmlsdrXZM1Rzg0U5mu35G7LdbmTdaxRA3WggylWtKviGd6Q+6+SEIvR5/hEmWibxxHXuFZZYwmuefCMCypHTr+4VZzAEje0fMceAa9Nxz8LCSN3FEcWWIm2QjOZCFb3pd8UBGOTetLIyK33mODEjymE0wx+anqdunfjCFKl3aRxmijzObGmIXNh/AChMQnVM="
    - secure: "Pgbh5KRNjEB3XC51aJ2gl0JP5HZ5/vHKcf6/wCJ5uBdCFZFJMvItuUJGrMs1N6bASeCnw3fLf6UbAkAPLn8TyzHj28A0XdABSZJjFDjZgzn65gmtUfO3bU04k106pOmQnZvqr2YBr+BnKkSY57tzJDXXbqZYwI25x8pQciWZ9e2veuL2nNtK7/SzmES+z8FeC/0lbrnYJseS35vKaBbmeW50zsp6HXBeIcJoazIjuxXP5qVhdV5NlMseCow96hhhAc92yVHumazQ92iYf0/2TXp7+r+uaZ0L+ryFYm0y/8K+Fbn3b7eQwBsMZKuhz8LLmGVYvpAPisa7z86z9+oyyOz/3gWUFN9bxbnHr9EiPKvv5Fd27mglBBVGBshr8OGOBSTM+S9eGRxvXQ3GcRciDZYIy/P1a+PZ+Rh3s1PDGuYWXyhU+D2qXs/4tzo4mveHm2EtmS8F98pUnJjd6I5UlAOZio6/ByUg3ARN/e8cvPIRsjcV8zlT9hchWxH6T9Rp05bXcz8r+uBx84h0GE5P7qXBangJ0XbzFkGY1PcD+QgHqzMAdQfqEMQl6fLHuZjEkbH4lZ4FVoNQFSgG7uPa8M3/GhBcA7Jqm4UEUbGP0MlTlLyqP5cmXedNPRL7cKAuIBQd0TUnAqcmEee3w557KXUlAa0LjUWENsCSAO5TbRw="
    - secure: "VTtKDvyCrxlUsAr9YUzbjeettc71wveBE1yKBG3AEVFXaqqh9F8qRy9XEPzimqNy6HIYwsEqVG8ForulDRx6CfF09tDI/MUJsUA4zEDUecAcOjeJOwepmrgzvADpH/xTOp0kTVunVElmh1chcUPKuQbMuj3uFIh9kV9o/3nwzwue9SicF62dWZ1MH1AIj6YGOe8doomVcybm4h1Qkiq5hDS/dx7cNT3zTqhY3J9sVf0s8sHG9VgwzMYfQk5nub52UWdPCrbgU2CC1bbtRstiDgVmkiJklIf81Vxn9lSxZH1vOuzGEljoKf9Yl4vozm4ESG/moaaFKyHzpDQUNWaryEMejVrXUFjdoddZoaH+5IAxCooe4O/Tk63Zp6h/ladF5glujNcHRupxbZNJpfC+w8cYiE1SFP0ZZPcf7hEYw6o+Crk+BdCtPMlNc43er4K7fqH0OawhkHgdl2XLuY+a8RApcYPLkSjcEmVqG2Nb2BITAVjDP2solyRNJ3DBMXZ2mytbW776U5s2aCJmrPStKDTCmAT5ArUJ+I1/to5anT8GBnujZBziUXW91Zsq6fXDOmbHLYTHN6vfSmy1PQ2OijXRECh+hFZCDqGUIPnHB9LJwF3FfXElAnoPrlry1uYErYVVsR2sRlGPCX9fFaO/ymjrxb/4ilkzbIhKUQou89Q="
    - secure: "mPdeLVaX8E+1uKCwZAhs122icr4sZyQhdnu5e9QVVQb/qyyQxj+VYipB5YZA5YEmKel9JgZ0zg+H8qt59i0sbdCzQ+cNwwW//Ezd9Xaym4UEn0lvJuQHjs+ZNr4+0XfMl60NwoAgQi2W//hYmGCAyEVN9MfltwVR7/GxKgy3Rm8CfhZY46XSoiD8XwIGU58BvsH/woRAo+nvBG5BjzeT+UKiMkvh3i/A5y7F471Urzqv8km9sG7UbUB9GJV17S+gS/ZDBuO7vb04cBZD2FMks0EIFWeIf6REN45CXqBBts9AOSaHGeLVma81A7TqkbHQUfKNh2pzMMtm8cVTB7JLMYLd0rBR/xMAE0TwWUWLrUgkEuduh9tvVgyiIsxD1RTw4B0rqdR7LZ3325KhxH3ybFccUsoCaVJNXJPt8ie1xAoP6zkSaKpRCQUFmhG/iPNsFC11NKtfclwwX9y/gXDagbXxtRBFP/20bwigubWaOGgt8BRho27oJgc2kP5yLaSPtCansIhLYcWy50kF0qS8xRqxPlh83kYaVNTCnVZxm1xW4CH0K6scJOVelfB+tFCgd1ueYQZ1O/fiLUD4QlhKfFJK0ZiRRwzYNA2gbN5GZnkZpekwVhJm7QWu1zPDbU/be5lrlt1ili/cMhqBpIXBOGeHmuT6OPyJ/KNWkOOzmM0="
